Bottom: 57c49bb54c28ffd41da0b641c52c54a95e397ab5
Top:    b9081271368fc3fd8f9a8c571292c9a6b4e2ea1d
Author: Ian Kent <raven@themaw.net>
Date:   2013-05-02 14:37:41 +0800

autofs-5.0.7 - use MS_UNBINDABLE


---

diff --git a/daemon/direct.c b/daemon/direct.c
index 228a666..1f5266c 100644
--- a/daemon/direct.c
+++ b/daemon/direct.c
@@ -426,6 +426,12 @@ int do_mount_autofs_direct(struct autofs_point *ap,
 		goto out_err;
 	}
 
+	ret = mount(NULL, me->key, NULL, MS_UNBINDABLE|MS_REC, NULL);
+	if (ret) {
+		warn(ap->logopt,
+		     "failed to set autofs mount unbindable path %s", me->key);
+	}
+
 	ret = stat(me->key, &st);
 	if (ret == -1) {
 		error(ap->logopt,
@@ -776,6 +782,13 @@ int mount_autofs_offset(struct autofs_point *ap, struct mapent *me, const char *
 		goto out_err;
 	}
 
+	ret = mount(NULL, mountpoint, NULL, MS_UNBINDABLE|MS_REC, NULL);
+	if (ret) {
+		warn(ap->logopt,
+		     "failed to set mount trigger %s unbindable at %s",
+		     me->key, mountpoint);
+	}
+
 	ret = stat(mountpoint, &st);
 	if (ret == -1) {
 		error(ap->logopt,
diff --git a/daemon/indirect.c b/daemon/indirect.c
index f4476dc..02a1de6 100644
--- a/daemon/indirect.c
+++ b/daemon/indirect.c
@@ -153,6 +153,13 @@ static int do_mount_autofs_indirect(struct autofs_point *ap, const char *root)
 		goto out_rmdir;
 	}
 
+	ret = mount(NULL, root, NULL, MS_UNBINDABLE|MS_REC, NULL);
+	if (ret) {
+		warn(ap->logopt,
+		     "failed to set autofs mount unbindable path %s at %s",
+		     ap->path, root);
+	}
+
 	free(options);
 	options = NULL;
 
diff --git a/include/automount.h b/include/automount.h
index e72fa0d..8a78ea0 100644
--- a/include/automount.h
+++ b/include/automount.h
@@ -75,6 +75,10 @@ int load_autofs4_module(void);
 #define SMB_SUPER_MAGIC    0x0000517BL
 #define CIFS_MAGIC_NUMBER  0xFF534D42L
 
+#ifndef MS_UNBINDABLE
+#define MS_UNBINDABLE (1 << 17)
+#endif
+
 /* This sould be enough for at least 20 host aliases */
 #define HOST_ENT_BUF_SIZE	2048
